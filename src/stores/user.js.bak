/* filepath: /Users/admin/exam-prep-app/src/stores/user.js */
import { defineStore } from 'pinia'
import { ref } from 'vue'

export const useUserStore = defineStore('user', () => {
  const user = ref(null)

  const loadUser = () => {
    try {
      const saved = localStorage.getItem('currentUser')
      if (saved) {
        const parsedUser = JSON.parse(saved)

        // –ù–æ—Ä–º–∞–ª–∏–∑—É–µ–º –ø–æ–ª—è –¥–ª—è —Å—Ç–∞–±–∏–ª—å–Ω—ã—Ö –ø—Ä–æ–≤–µ—Ä–æ–∫
        parsedUser.role = (parsedUser.role || '').toString()
        parsedUser.isAuthenticated = parsedUser.isAuthenticated === true || parsedUser.isAuthenticated === 'true' || !!parsedUser.token || !!parsedUser.id

        console.log('üë§ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –∑–∞–≥—Ä—É–∂–µ–Ω:', {
          email: parsedUser.email,
          role: parsedUser.role,
          hasToken: !!parsedUser.isAuthenticated
        })
        user.value = parsedUser
      } else {
        console.log('üë§ –ù–µ—Ç —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è')
        user.value = null
      }
    } catch (e) {
      console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è:', e)
      user.value = null
    }
  }

  const getRegisteredUsers = () => {
    try {
      const saved = localStorage.getItem('registeredUsers')
      return saved ? JSON.parse(saved) : []
    } catch (e) {
      console.error('–û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π:', e)
      return []
    }
  }

  // –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –Ω–æ–≤–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
  const register = (userData) => {
    try {
      const { name, email, password, group } = userData
      
      if (!name || !email || !password) {
        return { success: false, message: '–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –≤—Å–µ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–µ –ø–æ–ª—è' }
      }
      
      if (password.length < 6) {
        return { success: false, message: '–ü–∞—Ä–æ–ª—å –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –Ω–µ –º–µ–Ω–µ–µ 6 —Å–∏–º–≤–æ–ª–æ–≤' }
      }
      
      const existingUsers = getRegisteredUsers()
      
      if (existingUsers.some(u => u.email === email.toLowerCase())) {
        return { success: false, message: '–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Å —Ç–∞–∫–∏–º email —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç' }
      }
      
      const newUser = {
        id: Date.now().toString(),
        name: name.trim(),
        email: email.toLowerCase().trim(),
        password: password,
        group: group?.trim() || '',
        role: 'user',
        createdAt: new Date().toISOString(),
        lastLogin: new Date().toISOString(),
        loginCount: 1,
        isAuthenticated: true,
        progress: {
          completedTests: 0,
          correctAnswers: 0,
          totalAnswers: 0,
          averageScore: 0
        }
      }
      
      existingUsers.push(newUser)
      localStorage.setItem('registeredUsers', JSON.stringify(existingUsers))
      
      const allUsers = JSON.parse(localStorage.getItem('allUsers') || '[]')
      allUsers.push(newUser)
      localStorage.setItem('allUsers', JSON.stringify(allUsers))
      
      login(newUser)
      
      return { 
        success: true, 
        message: '–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è —É—Å–ø–µ—à–Ω–∞!',
        user: newUser 
      }
      
    } catch (e) {
      console.error('–û—à–∏–±–∫–∞ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏:', e)
      return { success: false, message: '–û—à–∏–±–∫–∞ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏' }
    }
  }

  // –í—Ö–æ–¥ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è (—Ç–µ—Ä–ø–∏–º –∫ —Ñ–æ—Ä–º–∞—Ç—É –ø–∞—Ä–æ–ª–µ–π: plain / base64)
  const login = (loginData) => {
    try {
      if (loginData && loginData.id && loginData.email) {
        const { password, ...userWithoutPassword } = loginData
        
        const safeUser = {
          ...userWithoutPassword,
          role: (userWithoutPassword.role || 'user').toString(),
          isAuthenticated: true
        }
        
        console.log('‚úÖ –í—Ö–æ–¥ —á–µ—Ä–µ–∑ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—é:', {
          email: safeUser.email,
          role: safeUser.role,
          hasToken: safeUser.isAuthenticated
        })
        
        user.value = safeUser
        localStorage.setItem('currentUser', JSON.stringify(safeUser))
        return { success: true, user: safeUser }
      }

      const { email, password } = loginData || {}
      if (!email || !password) {
        return { success: false, message: '–í–≤–µ–¥–∏—Ç–µ email –∏ –ø–∞—Ä–æ–ª—å' }
      }

      const registeredUsers = getRegisteredUsers()
      const searchEmail = email.toLowerCase().trim()

      const foundUser = registeredUsers.find(u => {
        if (!u || (u.email || '').toLowerCase().trim() !== searchEmail) return false

        // –ø—Ä—è–º–æ–µ —Å–æ–≤–ø–∞–¥–µ–Ω–∏–µ
        if (u.password === password) return true

        // —Å–æ–≤–ø–∞–¥–µ–Ω–∏–µ —Å base64 –æ—Ç –≤–≤–æ–¥–∏–º–æ–≥–æ
        try { if (u.password === btoa(password)) return true } catch (e) {}

        // —Å–æ–≤–ø–∞–¥–µ–Ω–∏–µ –µ—Å–ª–∏ stored ‚Äî base64 –∏ atob(stored) === input
        try { if (atob(u.password) === password) return true } catch (e) {}

        return false
      })

      if (!foundUser) {
        return { success: false, message: '–ù–µ–≤–µ—Ä–Ω—ã–π email –∏–ª–∏ –ø–∞—Ä–æ–ª—å' }
      }

      foundUser.lastLogin = new Date().toISOString()
      foundUser.loginCount = (foundUser.loginCount || 0) + 1

      const updatedUsers = registeredUsers.map(u => u.id === foundUser.id ? foundUser : u)
      localStorage.setItem('registeredUsers', JSON.stringify(updatedUsers))

      const { password: _, ...userWithoutPassword } = foundUser
      const safeUser = { ...userWithoutPassword, isAuthenticated: true }

      console.log('‚úÖ –£—Å–ø–µ—à–Ω—ã–π –≤—Ö–æ–¥:', {
        email: safeUser.email,
        role: safeUser.role,
        hasToken: safeUser.isAuthenticated
      })

      user.value = safeUser
      localStorage.setItem('currentUser', JSON.stringify(safeUser))

      return { success: true, user: safeUser }

    } catch (e) {
      console.error('–û—à–∏–±–∫–∞ –≤—Ö–æ–¥–∞:', e)
      return { success: false, message: '–û—à–∏–±–∫–∞ –≤—Ö–æ–¥–∞' }
    }
  }

  const logout = () => {
    console.log('üö™ –í—ã—Ö–æ–¥ –∏–∑ —Å–∏—Å—Ç–µ–º—ã')
    user.value = null
    localStorage.removeItem('currentUser')
  }

  const getAllUsers = () => {
    try {
      const users = getRegisteredUsers()
      return users.map(({ password, ...user }) => user)
    } catch (e) {
      console.error('–û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π:', e)
      return []
    }
  }

  const addUser = (newUser) => {
    const allUsers = JSON.parse(localStorage.getItem('allUsers') || '[]')
    allUsers.push(newUser)
    localStorage.setItem('allUsers', JSON.stringify(allUsers))
  }

  const isAuthenticated = () => {
    const hasUser = !!user.value
    const hasToken = user.value?.isAuthenticated === true
    console.log('üîê –ü—Ä–æ–≤–µ—Ä–∫–∞ –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏:', {
      –µ—Å—Ç—å–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å: hasUser,
      –µ—Å—Ç—å–¢–æ–∫–µ–Ω: hasToken,
      –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å: user.value?.email,
      —Ä–æ–ª—å: user.value?.role
    })
    return hasUser || hasToken
  }
  
  const isAdmin = () => {
    const role = (user.value?.role || '').toString()
    const result = /admin|–∞–¥–º–∏–Ω|–∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä/i.test(role)
    console.log('üëë –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ä–æ–ª–∏ –∞–¥–º–∏–Ω–∞:', {
      —Ä–æ–ª—å: role,
      —Ä–µ–∑—É–ª—å—Ç–∞—Ç: result,
      –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å: user.value?.email
    })
    return result
  }

  return { 
    user, 
    loadUser,
    register,
    login,
    logout,
    getAllUsers,
    addUser,
    isAuthenticated, 
    isAdmin 
  }
})
