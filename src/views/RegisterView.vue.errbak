<template>
  <v-container fluid fill-height class="pa-0 register-bg">
    <v-row align="start" justify="center" class="pa-6 mt-10">
      <v-col cols="12" sm="10" md="8" lg="5" xl="4">
        <!-- –í–µ—Ä—Ö–Ω–∏–π —Ç–µ–∫—Å—Ç–æ–≤—ã–π –±–ª–æ–∫ -->
        <div class="mb-6 text-center">
          <h2 class="text-h4 font-weight-bold mb-2 text-white">
            Create your exam account
          </h2>
          <p class="text-body-2 text-white text-medium-emphasis">
            Join the platform to track your progress and get ready for the state exam.
          </p>
        </div>

        <v-card class="pa-6 elevation-16 register-card" rounded="xl">
          <!-- –ò–∫–æ–Ω–∫–∞ -->
          <div class="d-flex justify-center mb-4">
            <v-avatar size="56" color="primary" class="elevation-3">
              <v-icon size="32" color="white">mdi-shield-check</v-icon>
            </v-avatar>
          </div>

          <v-card-title class="text-h6 font-weight-bold mb-1 text-center">
            Create your account
          </v-card-title>
          <v-card-subtitle class="text-body-2 mb-5 text-center text-medium-emphasis">
            It takes less than a minute.
          </v-card-subtitle>

          <!-- –û—à–∏–±–∫–∞ -->
          <v-alert 
            v-if="errorMessage" 
            type="error" 
            variant="tonal" 
            density="compact" 
            class="mb-4"
          >
            {{ errorMessage }}
          </v-alert>

          <!-- –£—Å–ø–µ—Ö -->
          <v-alert 
            v-if="successMessage" 
            type="success" 
            variant="tonal" 
            density="compact" 
            class="mb-4"
          >
            {{ successMessage }}
          </v-alert>

          <v-form @submit.prevent="handleRegister">
            <v-text-field
              v-model="name"
              label="Full name"
              prepend-inner-icon="mdi-account-outline"
              variant="outlined"
              :rules="nameRules"
              class="mb-3"
              density="comfortable"
            />

            <v-text-field
              v-model="email"
              label="Email address"
              prepend-inner-icon="mdi-email-outline"
              variant="outlined"
              :rules="emailRules"
              class="mb-3"
              density="comfortable"
            />

            <v-text-field
              v-model="group"
              label="Group (optional)"
              prepend-inner-icon="mdi-school-outline"
              variant="outlined"
              class="mb-3"
              density="comfortable"
            />

            <v-text-field
              v-model="password"
              label="Password"
              prepend-inner-icon="mdi-lock-outline"
              :type="showPassword ? 'text' : 'password'"
              variant="outlined"
              :rules="passwordRules"
              class="mb-3"
              density="comfortable"
              :append-inner-icon="showPassword ? 'mdi-eye-off' : 'mdi-eye'"
              @click:append-inner="showPassword = !showPassword"
            />

            <v-text-field
              v-model="confirmPassword"
              label="Confirm password"
              prepend-inner-icon="mdi-lock-check-outline"
              :type="showConfirmPassword ? 'text' : 'password'"
              variant="outlined"
              :rules="confirmRules"
              class="mb-5"
              density="comfortable"
              :append-inner-icon="showConfirmPassword ? 'mdi-eye-off' : 'mdi-eye'"
              @click:append-inner="showConfirmPassword = !showConfirmPassword"
            />

            <v-btn
              type="submit"
              color="primary"
              block
              size="large"
              :loading="loading"
              :disabled="!isFormValid"
              class="text-none font-weight-bold mb-1"
            >
              SIGN UP
            </v-btn>

            <div class="text-caption text-medium-emphasis text-center mt-1">
              By signing up you agree to our exam preparation policy.
            </div>
          </v-form>

          <v-divider class="my-5" />

          <v-card-text class="text-center">
            <span class="text-body-2">Already have an account?</span>
            <v-btn
              variant="text"
              size="small"
              class="ml-1 text-none font-weight-bold"
              @click="goToLogin"
            >
              Log in
            </v-btn>
          </v-card-text>
        </v-card>
      </v-col>
    </v-row>
  </v-container>
</template>

<script setup>
import { ref, computed, watch } from 'vue'
import { useRouter } from 'vue-router'
import { useUserStore } from '@/stores/user'

const router = useRouter()
const userStore = useUserStore()

const name = ref('')
const email = ref('')
const group = ref('')
const password = ref('')
const confirmPassword = ref('')
const showPassword = ref(false)
const showConfirmPassword = ref(false)
const loading = ref(false)
const errorMessage = ref('')
const successMessage = ref('')

const nameRules = [v => !!v || '–ò–º—è –æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ']
const emailRules = [
  v => !!v || 'Email –æ–±—è–∑–∞—Ç–µ–ª–µ–Ω',
  v => /.+@.+\..+/.test(v) || 'Email –Ω–µ–∫–æ—Ä—Ä–µ–∫—Ç–µ–Ω'
]
const passwordRules = [
  v => !!v || '–ü–∞—Ä–æ–ª—å –æ–±—è–∑–∞—Ç–µ–ª–µ–Ω',
  v => (v && v.length >= 6) || '–ú–∏–Ω–∏–º—É–º 6 —Å–∏–º–≤–æ–ª–æ–≤'
]
const confirmRules = [
  v => !!v || '–ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ –ø–∞—Ä–æ–ª—è –æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ',
  v => v === password.value || '–ü–∞—Ä–æ–ª–∏ –Ω–µ —Å–æ–≤–ø–∞–¥–∞—é—Ç'
]

const isFormValid = computed(() => {
  return name.value && 
         email.value && 
         password.value && 
         confirmPassword.value && 
         password.value === confirmPassword.value
})

// –°–±—Ä–æ—Å –æ—à–∏–±–æ–∫ –ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ –ø–æ–ª–µ–π
watch([name, email, password, confirmPassword], () => {
  errorMessage.value = ''
  successMessage.value = ''
})

const goToLogin = () => {
  router.push('/login')
}

const handleRegister = async () => {
  errorMessage.value = ''
  successMessage.value = ''
  
  // –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø—Ä–∞–≤–∏–ª —Ñ–æ—Ä–º—ã
  if (!name.value || !email.value || !password.value || !confirmPassword.value) {
    errorMessage.value = '–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –≤—Å–µ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–µ –ø–æ–ª—è'
    return
  }
  
  if (password.value !== confirmPassword.value) {
    errorMessage.value = '–ü–∞—Ä–æ–ª–∏ –Ω–µ —Å–æ–≤–ø–∞–¥–∞—é—Ç'
    return
  }

  if (password.value.length < 6) {
    errorMessage.value = '–ü–∞—Ä–æ–ª—å –¥–æ–ª–∂–µ–Ω —Å–æ–¥–µ—Ä–∂–∞—Ç—å –º–∏–Ω–∏–º—É–º 6 —Å–∏–º–≤–æ–ª–æ–≤'
    return
  }

  loading.value = true
  
  try {
    // ‚úÖ –°–û–ó–î–ê–ï–ú –ü–û–õ–¨–ó–û–í–ê–¢–ï–õ–Ø
    const newUser = {
      id: Date.now().toString(), // –£–Ω–∏–∫–∞–ª—å–Ω—ã–π ID
      name: name.value.trim(),
      email: email.value.trim().toLowerCase(),
      password: password.value, // ‚ö†Ô∏è –°–æ—Ö—Ä–∞–Ω—è–µ–º –ø–∞—Ä–æ–ª—å –∫–∞–∫ –µ—Å—Ç—å (–≤ —Ä–µ–∞–ª—å–Ω–æ–º –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–∏ –Ω—É–∂–Ω–æ —Ö—ç—à–∏—Ä–æ–≤–∞—Ç—å!)
      group: group.value.trim() || '–ù–µ —É–∫–∞–∑–∞–Ω–∞',
      role: 'user', // –í—Å–µ –Ω–æ–≤—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ - –æ–±—ã—á–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏
      createdAt: new Date().toISOString(),
      lastLogin: new Date().toISOString(),
      loginCount: 1,
      isActive: true,
      isAuthenticated: true,
      progress: {
        completedTests: 0,
        correctAnswers: 0,
        totalAnswers: 0,
        averageScore: 0
      }
    }

    console.log('üîç –°–æ–∑–¥–∞–µ–º –Ω–æ–≤–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è:', newUser)
    
    // ‚úÖ –°–û–•–†–ê–ù–Ø–ï–ú –í LOCALSTORAGE –ß–ï–†–ï–ó –ü–†–û–°–¢–£–Æ –§–£–ù–ö–¶–ò–Æ
    saveUserToLocalStorage(newUser)
    
    // ‚úÖ –ê–í–¢–û–ú–ê–¢–ò–ß–ï–°–ö–ò –õ–û–ì–ò–ù–ò–ú –ü–û–õ–¨–ó–û–í–ê–¢–ï–õ–Ø
    userStore.login(newUser);
    window.dispatchEvent(new Event('users:updated'))
    
    console.log('‚úÖ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω –∏ –≤–æ—à–µ–ª –≤ —Å–∏—Å—Ç–µ–º—É!')
    
    successMessage.value = '–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è —É—Å–ø–µ—à–Ω–∞! –í—ã –±—É–¥–µ—Ç–µ –ø–µ—Ä–µ–Ω–∞–ø—Ä–∞–≤–ª–µ–Ω—ã...'
    
    // –ñ–¥–µ–º 2 —Å–µ–∫—É–Ω–¥—ã –∏ –ø–µ—Ä–µ—Ö–æ–¥–∏–º –Ω–∞ –≥–ª–∞–≤–Ω—É—é
    setTimeout(() => {
      router.push('/')
    }, 2000)
    
  } catch (e) {
    console.error('–û—à–∏–±–∫–∞ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏:', e)
    errorMessage.value = '–û—à–∏–±–∫–∞ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–∑–∂–µ.'
  } finally {
    loading.value = false
  }
}

// ‚úÖ –§–£–ù–ö–¶–ò–Ø –î–õ–Ø –°–û–•–†–ê–ù–ï–ù–ò–Ø –ü–û–õ–¨–ó–û–í–ê–¢–ï–õ–Ø –í LOCALSTORAGE
const saveUserToLocalStorage = (userData) => {
  try {
    // –ü–æ–ª—É—á–∞–µ–º —Å—É—â–µ—Å—Ç–≤—É—é—â–∏—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
    let existingUsers = []
    const savedUsers = localStorage.getItem('registeredUsers')
    
    if (savedUsers) {
      existingUsers = JSON.parse(savedUsers)
    }
    
    // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –Ω–µ—Ç –ª–∏ —É–∂–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è —Å —Ç–∞–∫–∏–º email
    const userExists = existingUsers.find(u => u.email === userData.email)
    if (userExists) {
      throw new Error('–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Å —Ç–∞–∫–∏–º email —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç')
    }
    
    // –î–æ–±–∞–≤–ª—è–µ–º –Ω–æ–≤–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
    existingUsers.push(userData)
    
    // –°–æ—Ö—Ä–∞–Ω—è–µ–º –æ–±–Ω–æ–≤–ª–µ–Ω–Ω—ã–π —Å–ø–∏—Å–æ–∫
    localStorage.setItem('registeredUsers', JSON.stringify(existingUsers))
    
    console.log('üìÅ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Å–æ—Ö—Ä–∞–Ω–µ–Ω –≤ localStorage:', userData.email)
    console.log('üìä –í—Å–µ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π:', existingUsers.length)
    
    // –¢–∞–∫–∂–µ —Å–æ—Ö—Ä–∞–Ω—è–µ–º –æ—Ç–¥–µ–ª—å–Ω–æ –¥–ª—è —Ç–µ—Å—Ç–æ–≤ (–≤ allUsers –∫–∞–∫ —Ä–∞–Ω—å—à–µ)
    let allUsers = []
    const savedAllUsers = localStorage.getItem('allUsers')
    if (savedAllUsers) {
      allUsers = JSON.parse(savedAllUsers)
    }
    allUsers.push(userData)
    localStorage.setItem('allUsers', JSON.stringify(allUsers))
    
  } catch (error) {
    console.error('–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è:', error)
    throw error
  }
}
</script>

<style scoped>
.register-bg {
  width: 100%;
  min-height: 100vh;
  background: linear-gradient(135deg, #0f172a 0%, #1e293b 100%);
}

.register-card {
  border-radius: 24px;
  background-color: #ffffff;
  max-width: 520px;
  margin: 0 auto;
  box-shadow: 0 20px 40px rgba(0,0,0,0.1) !important;
}

.text-white {
  color: white !important;
}
</style>