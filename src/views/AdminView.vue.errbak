<template>
  <v-container fluid class="super-admin-panel">
    <!-- –û–¢–õ–ê–î–û–ß–ù–ê–Ø –ò–ù–§–û–†–ú–ê–¶–ò–Ø -->
    <v-alert
      v-if="debugMode"
      type="info"
      variant="tonal"
      class="mb-4"
    >
      <div class="d-flex justify-space-between align-center">
        <div>
          <strong>–û—Ç–ª–∞–¥–∫–∞:</strong> –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π: {{ users.length }} | 
          –ü–æ—Å–ª–µ–¥–Ω–µ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ: {{ lastLoadTime || '–Ω–∏–∫–æ–≥–¥–∞' }}
        </div>
        <v-btn size="small" @click="debugUsers" color="primary">
          üîç –ü–æ–∫–∞–∑–∞—Ç—å –≤ –∫–æ–Ω—Å–æ–ª–∏
        </v-btn>
      </div>
    </v-alert>

    <v-row class="mb-8">
      <v-col>
        <div class="header-content">
          <div class="header-text">
            <h1 class="text-h3 font-weight-bold mb-2 gradient-text">
              <v-icon start size="40" color="primary">mdi-shield-crown</v-icon>
              –°—É–ø–µ—Ä –ê–¥–º–∏–Ω –ü–∞–Ω–µ–ª—å
            </h1>
            <p class="text-body-1 text-medium-emphasis">
              <v-icon size="16" class="mr-1">mdi-account-group</v-icon>
              –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º–∏ –∏ —ç–∫–∑–∞–º–µ–Ω–∞–º–∏ 
              <span class="font-weight-bold text-primary">{{ users.length }}</span> –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
            </p>
          </div>
          <div class="header-actions">
            <v-btn
              color="blue-darken-1"
              variant="tonal"
              prepend-icon="mdi-refresh"
              @click="loadAllData"
              :loading="globalLoading"
              class="action-btn"
            >
              –û–±–Ω–æ–≤–∏—Ç—å –≤—Å–µ
            </v-btn>
            <v-btn
              color="green-darken-1"
              prepend-icon="mdi-account-plus"
              @click="openCreateUser"
              class="action-btn"
              elevation="2"
            >
              –ù–æ–≤—ã–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å
            </v-btn>
            <v-btn
              color="indigo-darken-1"
              variant="tonal"
              prepend-icon="mdi-api"
              @click="testApiEndpoints"
              class="action-btn"
            >
              –¢–µ—Å—Ç API
            </v-btn>
          </div>
        </div>

        <v-row class="stats-row">
          <v-col v-for="stat in stats" :key="stat.title" cols="12" sm="6" md="3">
            <v-card 
              class="stat-card pa-4 elevation-3" 
              height="100%"
              :class="stat.colorClass"
              :ripple="false"
            >
              <div class="d-flex align-center justify-space-between">
                <div>
                  <div class="text-h4 font-weight-bold mb-1">
                    {{ stat.count }}
                  </div>
                  <div class="text-caption text-medium-emphasis">
                    {{ stat.title }}
                  </div>
                </div>
                <v-icon 
                  :color="stat.iconColor" 
                  size="40"
                  class="stat-icon"
                >
                  {{ stat.icon }}
                </v-icon>
              </div>
            </v-card>
          </v-col>
        </v-row>
      </v-col>
    </v-row>

    <v-card class="main-card elevation-4">
      <v-tabs 
        v-model="activeTab" 
        color="primary" 
        grow
        class="rounded-t-lg"
      >
        <v-tab value="users">
          <v-icon start>mdi-account-group</v-icon>
          –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏
          <v-chip size="small" color="primary" class="ml-2">
            {{ users.length }}
          </v-chip>
        </v-tab>
        <v-tab value="exams">
          <v-icon start>mdi-book-check</v-icon>
          –≠–∫–∑–∞–º–µ–Ω—ã
          <v-chip size="small" color="green" class="ml-2">
            {{ exams.length }}
          </v-chip>
        </v-tab>
      </v-tabs>

      <v-divider></v-divider>

      <v-window v-model="activeTab">
        <!-- –ü–û–õ–¨–ó–û–í–ê–¢–ï–õ–ò -->
        <v-window-item value="users">
          <div class="pa-6">
            <div class="d-flex justify-space-between align-center mb-6">
              <div>
                <h3 class="text-h5 font-weight-bold text-grey-darken-3">
                  <v-icon start color="primary">mdi-account-group</v-icon>
                  –í—Å–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏
                </h3>
                <p class="text-caption text-medium-emphasis mt-1">
                  –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —É—á–µ—Ç–Ω—ã–º–∏ –∑–∞–ø–∏—Å—è–º–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π —Å–∏—Å—Ç–µ–º—ã
                </p>
              </div>
              <div class="d-flex align-center gap-2">
                <v-text-field
                  v-model="userSearch"
                  placeholder="–ü–æ–∏—Å–∫ –ø–æ –∏–º–µ–Ω–∏, email –∏–ª–∏ –≥—Ä—É–ø–ø–µ..."
                  prepend-inner-icon="mdi-magnify"
                  variant="outlined"
                  density="compact"
                  style="max-width: 300px;"
                  hide-details
                />
                <v-btn 
                  color="success" 
                  prepend-icon="mdi-plus" 
                  @click="openCreateUser"
                  class="add-btn"
                  size="large"
                >
                  –î–æ–±–∞–≤–∏—Ç—å
                </v-btn>
              </div>
            </div>

            <v-data-table
              :headers="userHeaders"
              :items="filteredUsers"
              :loading="loading.users"
              class="data-table elevation-1"
              hover
              :items-per-page="15"
              fixed-header
            >
              <template #loading>
                <v-row justify="center" align="center" class="py-8">
                  <v-progress-circular indeterminate color="primary"></v-progress-circular>
                  <span class="ml-3">–ó–∞–≥—Ä—É–∑–∫–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π...</span>
                </v-row>
              </template>

              <template #item.name="{ item }">
                <div class="d-flex align-center">
                  <v-avatar size="32" :color="item.role === 'admin' ? 'deep-orange' : 'blue'" class="mr-3">
                    <span class="text-white">{{ getInitials(item.name) }}</span>
                  </v-avatar>
                  <div>
                    <div class="font-weight-medium">{{ item.name }}</div>
                    <div class="text-caption text-medium-emphasis">{{ item.email }}</div>
                  </div>
                </div>
              </template>

              <template #item.createdAt="{ item }">
                <div class="text-no-wrap">
                  {{ formatDate(item.createdAt) }}
                </div>
              </template>

              <template #item.role="{ item }">
                <v-chip
                  :color="item.role === 'admin' ? 'deep-orange' : 'blue'"
                  size="small"
                  class="font-weight-bold"
                  :prepend-icon="item.role === 'admin' ? 'mdi-shield-account' : 'mdi-account'"
                >
                  {{ item.role === 'admin' ? '–ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä' : '–°—Ç—É–¥–µ–Ω—Ç' }}
                </v-chip>
              </template>

              <template #item.actions="{ item }">
                <div class="d-flex gap-2">
                  <v-tooltip text="–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å" location="top">
                    <template v-slot:activator="{ props }">
                      <v-btn 
                        size="small" 
                        color="primary" 
                        variant="tonal" 
                        v-bind="props"
                        @click="editUser(item)"
                        icon
                      >
                        <v-icon>mdi-pencil</v-icon>
                      </v-btn>
                    </template>
                  </v-tooltip>
                  
                  <v-tooltip text="–£–¥–∞–ª–∏—Ç—å" location="top">
                    <template v-slot:activator="{ props }">
                      <v-btn 
                        size="small" 
                        color="error" 
                        variant="tonal" 
                        v-bind="props"
                        @click="confirmDeleteUser(item)"
                        icon
                      >
                        <v-icon>mdi-delete</v-icon>
                      </v-btn>
                    </template>
                  </v-tooltip>
                </div>
              </template>

              <template #no-data>
                <div class="py-8 text-center">
                  <v-icon size="48" color="grey-lighten-1" class="mb-3">mdi-account-off</v-icon>
                  <div class="text-h6 text-grey">–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω—ã</div>
                  <v-btn color="primary" @click="openCreateUser" class="mt-4">
                    –î–æ–±–∞–≤–∏—Ç—å –ø–µ—Ä–≤–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
                  </v-btn>
                </div>
              </template>
            </v-data-table>
          </div>
        </v-window-item>

        <v-window-item value="exams">
          <div class="pa-6">
            <div class="d-flex justify-space-between align-center mb-6">
              <div>
                <h3 class="text-h5 font-weight-bold text-grey-darken-3">
                  <v-icon start color="green">mdi-book-check</v-icon>
                  –≠–∫–∑–∞–º–µ–Ω—ã
                </h3>
                <p class="text-caption text-medium-emphasis mt-1">
                  –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —ç–∫–∑–∞–º–µ–Ω–∞–º–∏ –∏ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞–º–∏
                </p>
              </div>
              <div class="d-flex align-center gap-4">
                <v-select
                  v-model="filterStatus"
                  :items="statusFilters"
                  item-title="title"
                  item-value="value"
                  label="–§–∏–ª—å—Ç—Ä –ø–æ —Å—Ç–∞—Ç—É—Å—É"
                  clearable
                  prepend-inner-icon="mdi-filter"
                  style="min-width: 200px; max-width: 250px;"
                  variant="outlined"
                  density="compact"
                />
              </div>
            </div>

            <v-data-table
              :headers="examHeaders"
              :items="filteredExams"
              :loading="loading.exams"
              class="data-table elevation-1"
              hover
              :items-per-page="15"
            >
              <template #loading>
                <v-row justify="center" align="center" class="py-8">
                  <v-progress-circular indeterminate color="green"></v-progress-circular>
                  <span class="ml-3">–ó–∞–≥—Ä—É–∑–∫–∞ —ç–∫–∑–∞–º–µ–Ω–æ–≤...</span>
                </v-row>
              </template>

              <template #item.user="{ item }">
                <div class="d-flex align-center">
                  <v-avatar size="32" color="blue" class="mr-3">
                    <span class="text-white">{{ getInitials(getUserName(item.userId)) }}</span>
                  </v-avatar>
                  <div>
                    <div class="font-weight-medium">{{ getUserName(item.userId) }}</div>
                    <div class="text-caption text-medium-emphasis">{{ getUserEmail(item.userId) }}</div>
                  </div>
                </div>
              </template>

              <template #item.status="{ item }">
                <v-chip 
                  :color="getStatusColor(item.status)" 
                  size="small"
                  :prepend-icon="getStatusIcon(item.status)"
                  class="font-weight-medium"
                >
                  {{ getStatusLabel(item.status) }}
                </v-chip>
              </template>

              <template #item.score="{ item }">
                <div class="d-flex align-center">
                  <v-progress-circular
                    v-if="item.score !== undefined"
                    :model-value="item.score"
                    :color="getScoreColor(item.score)"
                    size="30"
                    width="3"
                    class="mr-2"
                  >
                    {{ item.score }}
                  </v-progress-circular>
                  <span v-else class="text-grey">‚Äî</span>
                </div>
              </template>

              <template #item.actions="{ item }">
                <div class="d-flex gap-2">
                  <v-btn 
                    size="small" 
                    color="primary" 
                    variant="tonal" 
                    @click="editExam(item)"
                    prepend-icon="mdi-pencil"
                  >
                    –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å
                  </v-btn>
                  <v-btn 
                    size="small" 
                    color="error" 
                    variant="tonal" 
                    @click="confirmDeleteExam(item)"
                    prepend-icon="mdi-delete"
                  >
                    –£–¥–∞–ª–∏—Ç—å
                  </v-btn>
                </div>
              </template>

              <template #no-data>
                <div class="py-8 text-center">
                  <v-icon size="48" color="grey-lighten-1" class="mb-3">mdi-book-remove</v-icon>
                  <div class="text-h6 text-grey">–≠–∫–∑–∞–º–µ–Ω—ã –Ω–µ –Ω–∞–π–¥–µ–Ω—ã</div>
                  <p class="text-medium-emphasis mt-2">–°–æ–∑–¥–∞–π—Ç–µ —ç–∫–∑–∞–º–µ–Ω –∏–ª–∏ –ø—Ä–æ–≤–µ—Ä—å—Ç–µ —Ñ–∏–ª—å—Ç—Ä—ã</p>
                </div>
              </template>
            </v-data-table>
          </div>
        </v-window-item>
      </v-window>
    </v-card>

    <v-dialog v-model="showUserDialog" max-width="600" persistent>
      <v-card class="dialog-card">
        <v-card-title class="dialog-header">
          <div class="d-flex align-center">
            <v-icon :color="editingUser ? 'warning' : 'success'" class="mr-3">
              {{ editingUser ? 'mdi-account-edit' : 'mdi-account-plus' }}
            </v-icon>
            <span class="text-h6 font-weight-bold">
              {{ editingUser ? '–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è' : '–°–æ–∑–¥–∞–Ω–∏–µ –Ω–æ–≤–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è' }}
            </span>
          </div>
          <v-btn icon @click="closeUserDialog" variant="text" size="small">
            <v-icon>mdi-close</v-icon>
          </v-btn>
        </v-card-title>
        
        <v-divider></v-divider>
        
        <v-card-text class="pt-6">
          <v-form ref="userFormRef" v-model="userFormValid" @submit.prevent="saveUser">
            <v-row>
              <v-col cols="12" md="6">
                <v-text-field
                  v-model="userForm.name"
                  label="–§–ò–û *"
                  :rules="requiredRule"
                  variant="outlined"
                  prepend-inner-icon="mdi-account"
                  placeholder="–ò–≤–∞–Ω–æ–≤ –ò–≤–∞–Ω –ò–≤–∞–Ω–æ–≤–∏—á"
                />
              </v-col>
              <v-col cols="12" md="6">
                <v-text-field
                  v-model="userForm.email"
                  label="Email *"
                  :rules="emailRule"
                  variant="outlined"
                  prepend-inner-icon="mdi-email"
                  placeholder="example@mail.com"
                />
              </v-col>
              <v-col cols="12" md="6">
                <v-text-field
                  v-model="userForm.group"
                  label="–ì—Ä—É–ø–ø–∞"
                  variant="outlined"
                  prepend-inner-icon="mdi-account-group"
                  placeholder="–ò–¢-21"
                />
              </v-col>
              <v-col cols="12" md="6">
                <v-select
                  v-model="userForm.role"
                  label="–†–æ–ª—å *"
                  :items="roles"
                  item-title="title"
                  item-value="value"
                  variant="outlined"
                  prepend-inner-icon="mdi-shield-account"
                />
              </v-col>
              <v-col v-if="!editingUser" cols="12" md="6">
                <v-text-field
                  v-model="userForm.password"
                  label="–ü–∞—Ä–æ–ª—å *"
                  type="password"
                  :rules="passwordRules"
                  variant="outlined"
                  prepend-inner-icon="mdi-lock"
                  placeholder="–ú–∏–Ω–∏–º—É–º 6 —Å–∏–º–≤–æ–ª–æ–≤"
                />
              </v-col>
              <v-col v-if="!editingUser" cols="12" md="6">
                <v-text-field
                  v-model="userForm.confirmPassword"
                  label="–ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ –ø–∞—Ä–æ–ª—è *"
                  type="password"
                  :rules="confirmPasswordRules"
                  variant="outlined"
                  prepend-inner-icon="mdi-lock-check"
                  placeholder="–ü–æ–≤—Ç–æ—Ä–∏—Ç–µ –ø–∞—Ä–æ–ª—å"
                />
              </v-col>
            </v-row>
          </v-form>
        </v-card-text>
        
        <v-divider></v-divider>
        
        <v-card-actions class="pa-4">
          <v-spacer />
          <v-btn @click="closeUserDialog" variant="tonal" size="large">
            –û—Ç–º–µ–Ω–∞
          </v-btn>
          <v-btn
            color="primary"
            @click="saveUser"
            :loading="savingUser"
            :disabled="!userFormValid"
            size="large"
            prepend-icon="mdi-check"
          >
            {{ editingUser ? '–û–±–Ω–æ–≤–∏—Ç—å' : '–°–æ–∑–¥–∞—Ç—å' }}
          </v-btn>
        </v-card-actions>
      </v-card>
    </v-dialog>

    <v-snackbar
      v-model="showSnackbar"
      :color="snackbarColor"
      :timeout="4000"
      location="top right"
    >
      <div class="d-flex align-center">
        <v-icon class="mr-3">{{ snackbarIcon }}</v-icon>
        {{ snackbarMessage }}
      </div>
      <template v-slot:actions>
        <v-btn icon @click="showSnackbar = false">
          <v-icon>mdi-close</v-icon>
        </v-btn>
      </template>
    </v-snackbar>
  </v-container>
</template>

<script setup>
import { ref, computed, reactive, onMounted, nextTick } from 'vue'
import { apiGet, apiPost, apiPut, apiDelete } from '@/api'


const debugMode = ref(true)
const lastLoadTime = ref(null)
const userSearch = ref('')


const users = ref([])
const exams = ref([])
const loading = reactive({ users: false, exams: false })
const globalLoading = ref(false)


const activeTab = ref('users')
const filterStatus = ref('')


const showUserDialog = ref(false)
const editingUser = ref(null)
const userFormRef = ref(null)
const userFormValid = ref(false)
const savingUser = ref(false)

const userForm = ref({
  name: '',
  email: '',
  group: '',
  role: 'user',
  password: '',
  confirmPassword: ''
})


const showSnackbar = ref(false)
const snackbarMessage = ref('')
const snackbarColor = ref('success')
const snackbarIcon = ref('mdi-check-circle')


const userHeaders = [
  { title: '–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å', key: 'name', sortable: true, width: '300px' },
  { title: '–ì—Ä—É–ø–ø–∞', key: 'group', sortable: true },
  { title: '–î–∞—Ç–∞ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏', key: 'createdAt', sortable: true },
  { title: '–†–æ–ª—å', key: 'role', sortable: true },
  { title: '–î–µ–π—Å—Ç–≤–∏—è', key: 'actions', align: 'end', sortable: false }
]

const examHeaders = [
  { title: '–°—Ç—É–¥–µ–Ω—Ç', key: 'user', sortable: true, width: '250px' },
  { title: '–ü—Ä–µ–¥–º–µ—Ç', key: 'subject', sortable: true },
  { title: '–î–∞—Ç–∞ —ç–∫–∑–∞–º–µ–Ω–∞', key: 'date', sortable: true },
  { title: '–°—Ç–∞—Ç—É—Å', key: 'status', sortable: true },
  { title: '–ë–∞–ª–ª', key: 'score', sortable: true },
  { title: '–î–µ–π—Å—Ç–≤–∏—è', key: 'actions', align: 'end', sortable: false }
]


const roles = [
  { title: '–°—Ç—É–¥–µ–Ω—Ç', value: 'user' },
  { title: '–ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä', value: 'admin' }
]

const statusFilters = [
  { title: '–í—Å–µ —Å—Ç–∞—Ç—É—Å—ã', value: '' },
  { title: '–ó–∞–ø–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω', value: 'planned', color: 'warning' },
  { title: '–ü—Ä–æ–π–¥–µ–Ω', value: 'passed', color: 'success' },
  { title: '–ü—Ä–æ–≤–∞–ª–µ–Ω', value: 'failed', color: 'error' }
]


const requiredRule = [v => !!v || '–û–±—è–∑–∞—Ç–µ–ª—å–Ω–æ–µ –ø–æ–ª–µ']
const emailRule = [
  v => !!v || '–û–±—è–∑–∞—Ç–µ–ª—å–Ω–æ–µ –ø–æ–ª–µ',
  v => /.+@.+\..+/.test(v) || '–ù–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π email'
]
const passwordRules = [
  v => !!v || '–û–±—è–∑–∞—Ç–µ–ª—å–Ω–æ–µ –ø–æ–ª–µ',
  v => v.length >= 6 || '–ú–∏–Ω–∏–º—É–º 6 —Å–∏–º–≤–æ–ª–æ–≤'
]
const confirmPasswordRules = [
  v => !!v || '–û–±—è–∑–∞—Ç–µ–ª—å–Ω–æ–µ –ø–æ–ª–µ',
  v => v === userForm.value.password || '–ü–∞—Ä–æ–ª–∏ –Ω–µ —Å–æ–≤–ø–∞–¥–∞—é—Ç'
]

// === COMPUTED ===
const stats = computed(() => {
  const students = users.value.filter(u => u.role === 'user')
  const admins = users.value.filter(u => u.role === 'admin')
  const totalUsers = users.value.length
  const totalExams = exams.value.length
  
  return [
    {
      title: '–°—Ç—É–¥–µ–Ω—Ç–æ–≤',
      count: students.length,
      icon: 'mdi-school',
      iconColor: 'blue',
      colorClass: 'stat-card-blue'
    },
    {
      title: '–ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–æ–≤',
      count: admins.length,
      icon: 'mdi-shield-account',
      iconColor: 'deep-orange',
      colorClass: 'stat-card-orange'
    },
    {
      title: '–í—Å–µ–≥–æ —ç–∫–∑–∞–º–µ–Ω–æ–≤',
      count: totalExams,
      icon: 'mdi-book-multiple',
      iconColor: 'green',
      colorClass: 'stat-card-green'
    },
    {
      title: '–ü—Ä–æ–≤–∞–ª–µ–Ω–Ω—ã—Ö',
      count: exams.value.filter(e => e.status === 'failed').length,
      icon: 'mdi-close-circle',
      iconColor: 'red',
      colorClass: 'stat-card-red'
    }
  ]
})

const filteredUsers = computed(() => {
  if (!userSearch.value) return users.value
  
  const search = userSearch.value.toLowerCase()
  return users.value.filter(user =>
    user.name?.toLowerCase().includes(search) ||
    user.email?.toLowerCase().includes(search) ||
    user.group?.toLowerCase().includes(search)
  )
})

const filteredExams = computed(() => {
  if (!filterStatus.value) return exams.value
  return exams.value.filter(e => e.status === filterStatus.value)
})


const formatDate = date => {
  if (!date) return '–ù–µ —É–∫–∞–∑–∞–Ω–æ'
  return new Date(date).toLocaleDateString('ru-RU', {
    day: '2-digit',
    month: '2-digit',
    year: 'numeric',
    hour: '2-digit',
    minute: '2-digit'
  })
}

const getInitials = (name) => {
  if (!name) return '??'
  return name.split(' ').map(word => word[0]).join('').toUpperCase().slice(0, 2)
}

const getUserName = userId => {
  const user = users.value.find(u => u.id == userId || u._id == userId)
  return user?.name || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ'
}

const getUserEmail = userId => {
  const user = users.value.find(u => u.id == userId || u._id == userId)
  return user?.email || ''
}

const getStatusColor = status => ({
  planned: 'warning',
  passed: 'success',
  failed: 'error'
}[status] || 'grey')

const getStatusIcon = status => ({
  planned: 'mdi-clock-outline',
  passed: 'mdi-check-circle-outline',
  failed: 'mdi-close-circle-outline'
}[status] || 'mdi-help-circle')

const getStatusLabel = status => ({
  planned: '–ó–∞–ø–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω',
  passed: '–ü—Ä–æ–π–¥–µ–Ω',
  failed: '–ü—Ä–æ–≤–∞–ª–µ–Ω'
}[status] || status)

const getScoreColor = score => {
  if (score >= 90) return 'success'
  if (score >= 70) return 'warning'
  if (score >= 60) return 'orange'
  return 'error'
}

const showNotification = (message, color = 'success', icon = 'mdi-check-circle') => {
  snackbarMessage.value = message
  snackbarColor.value = color
  snackbarIcon.value = icon
  showSnackbar.value = true
}

const debugUsers = () => {
  console.log('üîç –¢–µ–∫—É—â–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏:', users.value)
  console.log('üìä –í—Å–µ–≥–æ:', users.value.length)
  console.log('üìã –ü—Ä–∏–º–µ—Ä:', users.value[0])
}

const loadUsers = async () => {
  loading.users = true
  console.log('üîÑ –ó–∞–≥—Ä—É–∑–∫–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π —Å —Å–µ—Ä–≤–µ—Ä–∞...')
  
  try {
    const response = await apiGet('/users')
    console.log('üì• –û—Ç–≤–µ—Ç –æ—Ç /users:', response)
    
    if (Array.isArray(response)) {

      users.value = response.map(user => {

        const id = user.id || user._id || user.userId

        const name = user.name || user.username || user.fullName || '–ë–µ–∑ –∏–º–µ–Ω–∏'

        const group = user.group || user.class || user.studentGroup || ''

        const email = user.email || user.mail || '–ù–µ—Ç email'

        const role = user.role || user.type || 'user'

        const createdAt = user.createdAt || user.createdDate || user.registrationDate || new Date().toISOString()
        
        return {
          id,
          name,
          email,
          group,
          role,
          createdAt
        }
      })
      
      console.log('‚úÖ –ü—Ä–µ–æ–±—Ä–∞–∑–æ–≤–∞–Ω–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π:', users.value.length)
      lastLoadTime.value = new Date().toLocaleTimeString()
      showNotification(`–ó–∞–≥—Ä—É–∂–µ–Ω–æ ${users.value.length} –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π`, 'success')
    } else {
      console.warn('‚ö†Ô∏è API –≤–µ—Ä–Ω—É–ª –Ω–µ –º–∞—Å—Å–∏–≤:', response)
      users.value = []
      showNotification('–û—à–∏–±–∫–∞: API –≤–µ—Ä–Ω—É–ª –Ω–µ–≤–µ—Ä–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç', 'error')
    }
    
  } catch (error) {
    console.error('‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π:', error)
    showNotification('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π', 'error', 'mdi-alert-circle')
  } finally {
    loading.users = false
  }
}

const loadExams = async () => {
  loading.exams = true
  try {
    const response = await apiGet('/exams')
    exams.value = Array.isArray(response) ? response : []
    console.log('‚úÖ –ó–∞–≥—Ä—É–∂–µ–Ω–æ —ç–∫–∑–∞–º–µ–Ω–æ–≤:', exams.value.length)
  } catch (error) {
    console.error('‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —ç–∫–∑–∞–º–µ–Ω–æ–≤:', error)
  } finally {
    loading.exams = false
  }
}

const loadAllData = async () => {
  globalLoading.value = true
  console.log('üöÄ –ó–∞–≥—Ä—É–∑–∫–∞ –≤—Å–µ—Ö –¥–∞–Ω–Ω—ã—Ö...')
  
  try {
    await Promise.all([
      loadUsers(),
      loadExams()
    ])
  } catch (error) {
    console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö:', error)
  } finally {
    globalLoading.value = false
  }
}


const testApiEndpoints = async () => {
  showNotification('–¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ API...', 'info', 'mdi-api')
  
  try {
    const usersResponse = await apiGet('/users')
    console.log('‚úÖ /users:', usersResponse)
    
    if (Array.isArray(usersResponse)) {
      showNotification(`API —Ä–∞–±–æ—Ç–∞–µ—Ç. –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π: ${usersResponse.length}`, 'success')
    } else {
      showNotification('API –≤–µ—Ä–Ω—É–ª –Ω–µ –º–∞—Å—Å–∏–≤', 'warning')
    }
  } catch (error) {
    console.error('‚ùå –û—à–∏–±–∫–∞ API:', error)
    showNotification(`–û—à–∏–±–∫–∞ API: ${error.message}`, 'error', 'mdi-alert-circle')
  }
}


const openCreateUser = () => {
  editingUser.value = null
  userForm.value = { 
    name: '', 
    email: '', 
    group: '', 
    role: 'user', 
    password: '',
    confirmPassword: ''
  }
  showUserDialog.value = true
  nextTick(() => userFormRef.value?.resetValidation())
}

const editUser = user => {
  editingUser.value = user
  userForm.value = {
    name: user.name,
    email: user.email,
    group: user.group || '',
    role: user.role,
    password: '',
    confirmPassword: ''
  }
  showUserDialog.value = true
  nextTick(() => userFormRef.value?.resetValidation())
}

const closeUserDialog = () => {
  showUserDialog.value = false
  editingUser.value = null
  nextTick(() => userFormRef.value?.resetValidation())
}

const saveUser = async () => {
  if (!userFormValid.value) return
  
  savingUser.value = true
  try {
    if (editingUser.value) {

      const payload = {
        name: userForm.value.name,
        email: userForm.value.email,
        group: userForm.value.group,
        role: userForm.value.role
      }
      
      console.log('‚úèÔ∏è –†–µ–¥–∞–∫—Ç–∏—Ä—É–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è:', editingUser.value.id, payload)
      await apiPut(`/users/${editingUser.value.id}`, payload)
      

      const index = users.value.findIndex(u => u.id === editingUser.value.id)
      if (index > -1) {
        users.value[index] = { ...users.value[index], ...payload }
      }
      
      showNotification('–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —É—Å–ø–µ—à–Ω–æ –æ–±–Ω–æ–≤–ª–µ–Ω', 'success')
    } else {

      const payload = {
        name: userForm.value.name,
        email: userForm.value.email,
        group: userForm.value.group || '',
        role: userForm.value.role,
        password: userForm.value.password
      }

      console.log('üöÄ –°–æ–∑–¥–∞–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è:', payload)
      const response = await apiPost('/users', payload)
      console.log('üì• –û—Ç–≤–µ—Ç —Å–µ—Ä–≤–µ—Ä–∞:', response)


      const newUser = {
        id: response?.id || response?._id || Date.now().toString(),
        name: userForm.value.name,
        email: userForm.value.email,
        group: userForm.value.group || '',
        role: userForm.value.role,
        createdAt: response?.createdAt || new Date().toISOString()
      }
      

      users.value.unshift(newUser)
      showNotification(`–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å "${newUser.name}" —Å–æ–∑–¥–∞–Ω`, 'success')
    }

    closeUserDialog()
  } catch (error) {
    console.error('‚ùå –û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è:', error)
    showNotification(
      `–û—à–∏–±–∫–∞: ${error.message || '–ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å'}`,
      'error',
      'mdi-alert-circle'
    )
  } finally {
    savingUser.value = false
  }
}

const confirmDeleteUser = async user => {
  if (!confirm(`–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è "${user.name}"?\n–≠—Ç–æ –¥–µ–π—Å—Ç–≤–∏–µ –Ω–µ–ª—å–∑—è –æ—Ç–º–µ–Ω–∏—Ç—å.`)) return
  
  try {
    console.log('üóëÔ∏è –£–¥–∞–ª—è–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è:', user.id, user.name)
    await apiDelete(`/users/${user.id}`)
    
 
    users.value = users.value.filter(u => u.id !== user.id)
    
    showNotification(`–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å "${user.name}" —É–¥–∞–ª–µ–Ω`, 'warning', 'mdi-delete')
  } catch (error) {
    console.error('‚ùå –û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è:', error)
    showNotification('–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è', 'error', 'mdi-alert-circle')
  }
}


const editExam = exam => {
  showNotification(`–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —ç–∫–∑–∞–º–µ–Ω–∞ "${exam.subject}"`, 'info', 'mdi-pencil')
  console.log('–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —ç–∫–∑–∞–º–µ–Ω–∞:', exam)
}

const confirmDeleteExam = async exam => {
  if (!confirm(`–£–¥–∞–ª–∏—Ç—å —ç–∫–∑–∞–º–µ–Ω "${exam.subject}"?`)) return
  
  try {
    await apiDelete(`/exams/${exam.id}`)
    exams.value = exams.value.filter(e => e.id !== exam.id)
    showNotification(`–≠–∫–∑–∞–º–µ–Ω "${exam.subject}" —É–¥–∞–ª–µ–Ω`, 'warning', 'mdi-delete')
  } catch (error) {
    console.error('–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è —ç–∫–∑–∞–º–µ–Ω–∞:', error)
    showNotification('–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è —ç–∫–∑–∞–º–µ–Ω–∞', 'error', 'mdi-alert-circle')
  }
}


onMounted(() => {
  console.log('üöÄ –ê–¥–º–∏–Ω-–ø–∞–Ω–µ–ª—å –∑–∞–ø—É—â–µ–Ω–∞')
  loadAllData()
  

  window.addEventListener('users:updated', () => {
    console.log('üîî –ü–æ–ª—É—á–µ–Ω–æ —Å–æ–±—ã—Ç–∏–µ users:updated')
    loadUsers()
  })
})
</script>

<style scoped>
.super-admin-panel {
  background: linear-gradient(135deg, #f8fafc 0%, #e2e8f0 100%);
  min-height: 100vh;
  padding: 24px;
}

.header-content {
  display: flex;
  justify-content: space-between;
  align-items: flex-start;
  flex-wrap: wrap;
  gap: 24px;
  margin-bottom: 32px;
}

.header-text {
  flex: 1;
  min-width: 300px;
}

.header-actions {
  display: flex;
  gap: 12px;
  flex-wrap: wrap;
}

.action-btn {
  height: 44px;
  border-radius: 10px;
}

.gradient-text {
  background: linear-gradient(90deg, #1976d2 0%, #2196f3 100%);
  -webkit-background-clip: text;
  -webkit-text-fill-color: transparent;
  background-clip: text;
}

.stats-row {
  margin-bottom: 32px;
}

.stat-card {
  border-radius: 16px;
  transition: all 0.3s ease;
  cursor: default;
  border: 1px solid rgba(255, 255, 255, 0.8);
}

.stat-card:hover {
  transform: translateY(-4px);
  box-shadow: 0 12px 20px -10px rgba(0, 0, 0, 0.15);
}

.stat-card-blue {
  background: linear-gradient(135deg, #e3f2fd 0%, #bbdefb 100%);
  border-left: 4px solid #1976d2;
}

.stat-card-orange {
  background: linear-gradient(135deg, #fff3e0 0%, #ffe0b2 100%);
  border-left: 4px solid #f57c00;
}

.stat-card-green {
  background: linear-gradient(135deg, #e8f5e9 0%, #c8e6c9 100%);
  border-left: 4px solid #388e3c;
}

.stat-card-red {
  background: linear-gradient(135deg, #ffebee 0%, #ffcdd2 100%);
  border-left: 4px solid #d32f2f;
}

.stat-icon {
  opacity: 0.9;
}

.main-card {
  border-radius: 20px;
  overflow: hidden;
  margin-bottom: 32px;
}

.add-btn {
  border-radius: 12px;
  height: 48px;
}

.data-table {
  border-radius: 12px;
  overflow: hidden;
}

.data-table :deep(.v-data-table__th) {
  background-color: #f5f7fa;
  font-weight: 600;
  text-transform: uppercase;
  letter-spacing: 0.5px;
  font-size: 0.8rem;
}

.data-table :deep(.v-data-table__tr) {
  transition: background-color 0.2s ease;
}

.data-table :deep(.v-data-table__tr:hover) {
  background-color: rgba(33, 150, 243, 0.04);
}

.dialog-card {
  border-radius: 20px;
}

.dialog-header {
  padding: 24px 24px 16px 24px;
  background: linear-gradient(90deg, #1976d2 0%, #2196f3 100%);
  color: white;
}

.dialog-header .v-icon {
  color: white !important;
}

/* –ê–¥–∞–ø—Ç–∏–≤–Ω–æ—Å—Ç—å */
@media (max-width: 960px) {
  .header-content {
    flex-direction: column;
  }
  
  .header-actions {
    width: 100%;
    justify-content: flex-start;
  }
  
  .gradient-text {
    font-size: 2rem;
  }
}

@media (max-width: 600px) {
  .super-admin-panel {
    padding: 16px;
  }
  
  .header-actions {
    flex-direction: column;
  }
  
  .action-btn {
    width: 100%;
  }
  
  .data-table :deep(table) {
    display: block;
    overflow-x: auto;
  }
}
</style>